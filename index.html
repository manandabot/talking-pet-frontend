<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Bring your pets to life! Upload a photo and make your pet talk with AI-powered video generation.">
    <meta name="keywords" content="talking pet, AI video, pet animation, text to speech">
    <meta name="author" content="Talking Pet App">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Talking Pet">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêæ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêæ</text></svg>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;charset=utf-8,{%22name%22:%22Talking%20Pet%20App%22,%22short_name%22:%22TalkingPet%22,%22description%22:%22Make%20your%20pets%20talk%20with%20AI%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23667eea%22,%22theme_color%22:%22%23667eea%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêæ</text></svg>%22,%22sizes%22:%22any%22,%22type%22:%22image/svg+xml%22}]}">
    
    <title>Talking Pet App - Make Your Pet Talk with AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            margin: 0;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            max-height: 95vh;
            overflow-y: auto;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 15px;
                border-radius: 15px;
                max-height: 98vh;
            }
            
            h1 {
                font-size: 2em !important;
                margin-bottom: 20px !important;
            }
            
            .upload-area {
                padding: 20px !important;
            }
            
            .upload-icon {
                font-size: 2em !important;
            }
            
            .controls {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            button {
                padding: 12px 20px !important;
                font-size: 1em !important;
            }
            
            .api-config {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .feature-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .feature {
                padding: 15px !important;
            }
            
            textarea {
                height: 100px !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                max-height: 90vh;
            }
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.15);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .upload-text {
            color: #666;
            font-size: 1.1em;
        }

        input[type="file"] {
            display: none;
        }

        .preview-container {
            margin-top: 20px;
            text-align: center;
        }

        .pet-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .pet-image:hover {
            transform: scale(1.05);
        }

        .script-section {
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
            font-size: 1.1em;
        }

        textarea {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-weight: bold;
            margin: 20px 0;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .animation-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .mouth-animation {
            position: absolute;
            width: 30px;
            height: 20px;
            background: #ff6b6b;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.1s ease;
        }

        .mouth-animation.talking {
            opacity: 0.8;
            transform: scaleY(1.5);
        }

        .result-section {
            margin-top: 30px;
            text-align: center;
        }

        .pet-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .speech-bubble {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 15px;
            border-radius: 15px;
            border: 2px solid #667eea;
            color: #333;
            font-weight: bold;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 20;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #667eea;
        }

        .speech-bubble.active {
            opacity: 1;
        }

        .demo-text {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 20px 0;
        }

        .api-config {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
        }

        .api-config h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .api-grid select, .api-grid input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .api-grid select:focus, .api-grid input:focus {
            outline: none;
            border-color: #667eea;
        }

        .generation-mode {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(118, 75, 162, 0.05);
            border-radius: 10px;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .mode-button {
            flex: 1;
            padding: 8px 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .mode-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pet-type-section {
            display: none;
            margin-top: 15px;
        }

        .pet-type-section.active {
            display: block;
        }

        .features {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature {
            text-align: center;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
        }

        .feature-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .feature-text {
            color: #666;
            font-size: 0.9em;
        }

        .video-result-container {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            text-align: center;
        }

        .video-result-container video {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .video-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .video-actions button {
            flex: none;
            padding: 8px 15px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêæ Talking Pet</h1>
        
        <div class="api-config">
            <h3>üîß API Configuration</h3>
            <div class="api-grid">
                <div>
                    <label for="apiProvider">Video Provider:</label>
                    <select id="apiProvider">
                        <option value="browser">Browser TTS (Free Demo)</option>
                        <option value="kieai">Kie AI Veo 3 (Image-to-Video)</option>
                        <option value="kieai-text">Kie AI Veo 3 (Text-to-Video)</option>
                    </select>
                </div>
                <div>
                    <label for="apiKey">Kie AI API Key:</label>
                    <input type="password" id="apiKey" placeholder="Enter your Kie AI API key">
                </div>
            </div>
        </div>

        <div class="generation-mode">
            <label>üé¨ Generation Mode:</label>
            <div class="mode-toggle">
                <button class="mode-button active" id="imageToVideoBtn">Image-to-Video</button>
                <button class="mode-button" id="textToVideoBtn">Text-to-Video</button>
            </div>
            
            <div class="pet-type-section" id="petTypeSection">
                <label for="petType">Pet Type:</label>
                <select id="petType">
                    <option value="cute dog">Cute Dog</option>
                    <option value="fluffy cat">Fluffy Cat</option>
                    <option value="playful puppy">Playful Puppy</option>
                    <option value="elegant cat">Elegant Cat</option>
                    <option value="golden retriever">Golden Retriever</option>
                    <option value="persian cat">Persian Cat</option>
                    <option value="small rabbit">Small Rabbit</option>
                    <option value="colorful parrot">Colorful Parrot</option>
                </select>
            </div>
        </div>
        
        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì∏</div>
                <div class="upload-text">Click or drag your pet's photo here</div>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <div class="preview-container" id="previewContainer" style="display: none;">
                <div class="pet-container" id="petContainer">
                    <img id="petImage" class="pet-image" alt="Your pet">
                    <div class="speech-bubble" id="speechBubble"></div>
                    <div class="animation-overlay" id="animationOverlay"></div>
                </div>
            </div>
        </div>

        <div class="script-section">
            <label for="scriptInput">What should your pet say?</label>
            <textarea id="scriptInput" placeholder="Enter your script here... (e.g., 'Hello! I'm a good boy and I love treats!')"></textarea>
        </div>

        <div class="controls">
            <button id="generateBtn">üé¨ Make Pet Talk</button>
            <button id="stopBtn" style="display: none;">‚èπÔ∏è Stop</button>
            <button id="debugBtn" onclick="debugKieAI()" style="background: #ff6b6b;">üîç Debug API</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span id="loadingText">Processing your talking pet...</span>
        </div>

        <div class="demo-text">
            <p>üéØ Upload your pet's photo and enter text to bring them to life!</p>
            <p>For AI video generation, use Kie AI with your API key.</p>
        </div>

        <div class="features">
            <h3 style="text-align: center; color: #333; margin-bottom: 20px;">‚ú® Features</h3>
            <div class="feature-grid">
                <div class="feature">
                    <div class="feature-icon">üé§</div>
                    <div class="feature-text">Text-to-Speech</div>
                </div>
                <div class="feature">
                    <div class="feature-icon">üé≠</div>
                    <div class="feature-text">AI Video Generation</div>
                </div>
                <div class="feature">
                    <div class="feature-icon">üí¨</div>
                    <div class="feature-text">Speech Bubbles</div>
                </div>
                <div class="feature">
                    <div class="feature-icon">üé®</div>
                    <div class="feature-text">Visual Effects</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAudio = null;
        let animationInterval = null;
        let speechSynthesis = window.speechSynthesis;
        let generationMode = 'image-to-video'; // 'image-to-video' or 'text-to-video'
        
        // DOM elements
        const apiProvider = document.getElementById('apiProvider');
        const apiKey = document.getElementById('apiKey');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const petImage = document.getElementById('petImage');
        const petContainer = document.getElementById('petContainer');
        const speechBubble = document.getElementById('speechBubble');
        const animationOverlay = document.getElementById('animationOverlay');
        const scriptInput = document.getElementById('scriptInput');
        const generateBtn = document.getElementById('generateBtn');
        const stopBtn = document.getElementById('stopBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const uploadSection = document.getElementById('uploadSection');
        
        // Mode toggle elements
        const imageToVideoBtn = document.getElementById('imageToVideoBtn');
        const textToVideoBtn = document.getElementById('textToVideoBtn');
        const petTypeSection = document.getElementById('petTypeSection');
        const petType = document.getElementById('petType');

        // Mode toggle functionality
        imageToVideoBtn.addEventListener('click', () => {
            setGenerationMode('image-to-video');
        });

        textToVideoBtn.addEventListener('click', () => {
            setGenerationMode('text-to-video');
        });

        function setGenerationMode(mode) {
            generationMode = mode;
            
            // Update button states
            imageToVideoBtn.classList.toggle('active', mode === 'image-to-video');
            textToVideoBtn.classList.toggle('active', mode === 'text-to-video');
            
            // Show/hide relevant sections
            uploadSection.style.display = mode === 'image-to-video' ? 'block' : 'none';
            petTypeSection.classList.toggle('active', mode === 'text-to-video');
            
            // Update provider selection
            if (mode === 'text-to-video') {
                apiProvider.value = 'kieai-text';
            } else {
                apiProvider.value = 'kieai';
            }
            
            // Update button text
            generateBtn.textContent = mode === 'image-to-video' ? 'üé¨ Make Pet Talk' : 'üé¨ Generate Talking Pet';
        }

        // File upload handling
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (file.type.startsWith('image/')) {
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image is too large. Please use an image smaller than 5MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    petImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                    setupMouthAnimation();
                };
                reader.readAsDataURL(file);
            } else {
                alert('Please upload an image file.');
            }
        }

        function setupMouthAnimation() {
            animationOverlay.innerHTML = '';
            const mouthElement = document.createElement('div');
            mouthElement.className = 'mouth-animation';
            mouthElement.style.left = '50%';
            mouthElement.style.top = '70%';
            mouthElement.style.transform = 'translateX(-50%)';
            animationOverlay.appendChild(mouthElement);
        }

        // Generate talking pet
        generateBtn.addEventListener('click', () => {
            const script = scriptInput.value.trim();
            if (!script) {
                alert('Please enter a script for your pet to say!');
                return;
            }

            if (generationMode === 'image-to-video' && !petImage.src) {
                alert('Please upload a pet image first!');
                return;
            }

            generateTalkingPet(script);
        });

        stopBtn.addEventListener('click', () => {
            stopTalking();
        });

        async function generateTalkingPet(script) {
            loading.classList.add('active');
            generateBtn.style.display = 'none';
            stopBtn.style.display = 'block';

            // Show speech bubble
            speechBubble.textContent = script;
            speechBubble.classList.add('active');

            const provider = apiProvider.value;
            const key = apiKey.value;

            console.log('üéØ Provider selected:', provider);
            console.log('üé¨ Generation mode:', generationMode);

            try {
                if (provider === 'browser') {
                    await generateBrowserTTS(script);
                } else if (provider === 'kieai-text' || (generationMode === 'text-to-video' && provider === 'kieai')) {
                    if (!key) {
                        alert('Please enter your Kie AI API key for video generation');
                        resetUI();
                        return;
                    }
                    await generateTextToVideo(script, key, petType.value);
                } else if (provider === 'kieai' && generationMode === 'image-to-video') {
                    if (!key) {
                        alert('Please enter your Kie AI API key for video generation');
                        resetUI();
                        return;
                    }
                    await generateImageToVideo(script, key);
                } else {
                    alert('Please select a valid provider and enter your API key');
                    resetUI();
                    return;
                }
            } catch (error) {
                console.error('Generation Error:', error);
                alert('Error: ' + error.message);
                resetUI();
            }
        }

        async function generateBrowserTTS(script) {
            const utterance = new SpeechSynthesisUtterance(script);
            
            const voices = speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => 
                voice.name.includes('Google') || 
                voice.name.includes('Microsoft') ||
                voice.name.includes('Alex') ||
                voice.name.includes('Samantha')
            );
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }
            
            utterance.rate = 0.9;
            utterance.pitch = 1.2;
            utterance.volume = 0.8;

            utterance.onstart = () => {
                loading.classList.remove('active');
                startMouthAnimation();
            };

            utterance.onend = () => {
                resetUI();
            };

            utterance.onerror = () => {
                console.error('Speech synthesis error');
                resetUI();
            };

            currentAudio = utterance;
            speechSynthesis.speak(utterance);
        }

        async function generateImageToVideo(script, key) {
            try {
                console.log('üîó Using ImgBB + Kie AI for true image-to-video...');
                
                await testBackendConnectivity();
                
                // Get the image file
                const fileToUse = fileInput.files[0];
                if (!fileToUse) {
                    throw new Error('Please upload a pet image first');
                }
                
                console.log('üì∏ Converting image to base64...');
                loadingText.textContent = 'Processing your image...';
                
                const imageBase64 = await fileToBase64(fileToUse);
                console.log('‚úÖ Image converted, size:', imageBase64.length, 'characters');
                
                const payload = {
                    script: script,
                    apiKey: key,
                    imageBase64: imageBase64
                };
                
                loadingText.textContent = 'Uploading image and generating video...';
                
                // Use the new image-to-video endpoint that uploads to ImgBB first
                const response = await fetch('https://talking-pet-csx4.vercel.app/api/generate-image-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await handleKieAIResponse(response, key);
                
                if (result.success) {
                    displayVideoResult(result.videoUrl);
                } else {
                    throw new Error('Image-to-video generation failed');
                }
                
            } catch (error) {
                console.error('üí• Kie AI image-to-video error:', error.message);
                throw new Error(`Image-to-video failed: ${error.message}. Make sure your image is under 5MB and try again.`);
            }
        }

        async function generateTextToVideo(script, key, petTypeValue) {
            try {
                console.log('üé¨ Generating text-to-video...');
                loadingText.textContent = 'Creating AI video with text-to-video...';
                
                const response = await fetch('https://talking-pet-csx4.vercel.app/api/generate-text-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        script: script,
                        apiKey: key,
                        petType: petTypeValue
                    })
                });
                
                const result = await handleKieAIResponse(response, key);
                
                if (result.success) {
                    displayVideoResult(result.videoUrl);
                } else {
                    throw new Error('Text-to-video generation failed');
                }
                
            } catch (error) {
                console.error('üí• Text-to-video error:', error.message);
                throw error;
            }
        }

        async function testBackendConnectivity() {
            console.log('üîç Testing backend connectivity...');
            
            try {
                const healthResponse = await fetch('https://talking-pet-csx4.vercel.app/health', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors'
                });
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    console.log('‚úÖ Backend is reachable:', healthData);
                } else {
                    throw new Error(`Backend health check failed: ${healthResponse.status}`);
                }
            } catch (error) {
                console.error('‚ùå Backend connectivity error:', error.message);
                throw new Error('Cannot reach backend server. Please try again later.');
            }
        }

        async function handleKieAIResponse(response, key) {
            console.log('üì° Backend response:', response.status, response.statusText);
            
            if (!response.ok) {
                let errorData;
                try {
                    const responseText = await response.text();
                    console.log('üì¶ Error response:', responseText.substring(0, 200));
                    
                    try {
                        errorData = JSON.parse(responseText);
                    } catch {
                        errorData = { error: responseText };
                    }
                } catch {
                    errorData = { error: `HTTP ${response.status}` };
                }
                
                console.error('‚ùå Backend error:', errorData);
                
                const errorMessage = getErrorMessage(response.status, errorData.error);
                throw new Error(errorMessage);
            }

            const result = await response.json();
            console.log('‚úÖ Backend success:', result);

            if (result.success && result.data) {
                const data = result.data;
                
                if (data.videoUrl && data.status === 'completed') {
                    return {
                        success: true,
                        videoUrl: data.videoUrl
                    };
                } 
                else if (data.taskId) {
                    console.log('‚è≥ Video is processing, polling for completion...');
                    loadingText.textContent = 'Video is processing, please wait...';
                    return await pollForVideoCompletion(data.taskId, key);
                } 
                else {
                    throw new Error('Unexpected response format from Kie AI');
                }
            } else {
                throw new Error(result.error || 'Backend request failed');
            }
        }

        function getErrorMessage(status, errorText) {
            switch (status) {
                case 400:
                    return 'Invalid request. Please check your input and try again.';
                case 401:
                    return 'Invalid API key. Please check your Kie AI API key.';
                case 402:
                    return 'Insufficient credits. Please add credits to your Kie AI account.';
                case 404:
                    return 'Service not found. Please try again later.';
                case 422:
                    return 'Validation error. Please check your input parameters.';
                case 429:
                    return 'Rate limit exceeded. Please wait and try again.';
                case 455:
                    return 'Service temporarily unavailable. Please try again later.';
                case 500:
                    return 'Server error. Please try again later.';
                case 501:
                    return 'Generation failed. Please try with different parameters.';
                case 505:
                    return 'Feature disabled. This feature is currently unavailable.';
                default:
                    return errorText || `API error: ${status}`;
            }
        }

        async function pollForVideoCompletion(taskId, key, maxAttempts = 60) { 
            console.log('‚è≥ Starting polling for task:', taskId);
            
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                try {
                    console.log(`üîÑ Polling attempt ${attempt + 1}/${maxAttempts} for task ${taskId}`);
                    loadingText.textContent = `Generating video... (${attempt + 1}/${maxAttempts})`;
                    
                    const response = await fetch('https://talking-pet-csx4.vercel.app/api/check-status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            taskId: taskId,
                            apiKey: key
                        })
                    });

                    if (!response.ok) {
                        console.error(`‚ùå Status check failed: ${response.status}`);
                        if (attempt === maxAttempts - 1) {
                            throw new Error('Status check failed after all attempts');
                        }
                        continue;
                    }

                    const result = await response.json();
                    console.log('üìä Status check result:', result);
                    
                    if (result.success && result.data) {
                        const data = result.data;
                        
                        if (data.status === 'completed') {
                            if (data.videoUrl) {
                                console.log('‚úÖ Video completed:', data.videoUrl);
                                return {
                                    success: true,
                                    videoUrl: data.videoUrl
                                };
                            } else {
                                console.warn('‚ö†Ô∏è Status is completed but no video URL found');
                            }
                        } else if (data.status === 'failed' || data.status === 'error') {
                            throw new Error(`Video generation failed: ${data.message || 'Unknown error'}`);
                        } else if (data.status === 'processing') {
                            console.log('‚è≥ Still processing... waiting 5 seconds');
                        } else {
                            console.log('ü§î Unknown status:', data.status);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    
                } catch (error) {
                    console.error(`‚ùå Polling error on attempt ${attempt + 1}:`, error.message);
                    if (attempt === maxAttempts - 1) {
                        throw new Error(`Polling failed after ${maxAttempts} attempts: ${error.message}`);
                    }
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }
            
            throw new Error('Video generation timed out after 5 minutes');
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function displayVideoResult(videoUrl) {
            loading.classList.remove('active');
            
            // Remove any existing video results
            const existingResult = document.querySelector('.video-result-container');
            if (existingResult) existingResult.remove();
            
            // Create video container
            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-result-container';
            
            videoContainer.innerHTML = `
                <h3 style="color: #333; margin-bottom: 20px;">üéâ Your Talking Pet Video is Ready!</h3>
                <video controls style="max-width: 100%; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);">
                    <source src="${videoUrl}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="video-actions">
                    <button onclick="window.open('${videoUrl}', '_blank')">üì• Download Video</button>
                    <button onclick="shareVideo('${videoUrl}')">üì± Share Video</button>
                    <button onclick="copyVideoUrl('${videoUrl}')">üìã Copy Link</button>
                </div>
            `;
            
            document.querySelector('.container').appendChild(videoContainer);
            
            // Reset UI
            generateBtn.style.display = 'block';
            stopBtn.style.display = 'none';
        }

        function shareVideo(videoUrl) {
            if (navigator.share) {
                navigator.share({
                    title: 'Check out my talking pet!',
                    text: 'I made my pet talk using AI!',
                    url: videoUrl
                });
            } else {
                copyVideoUrl(videoUrl);
            }
        }

        function copyVideoUrl(videoUrl) {
            navigator.clipboard.writeText(videoUrl).then(() => {
                alert('Video URL copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = videoUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Video URL copied to clipboard!');
            });
        }

        function resetUI() {
            stopMouthAnimation();
            speechBubble.classList.remove('active');
            loading.classList.remove('active');
            generateBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            loadingText.textContent = 'Processing your talking pet...';
        }

        function startMouthAnimation() {
            const mouthElement = animationOverlay.querySelector('.mouth-animation');
            if (mouthElement) {
                animationInterval = setInterval(() => {
                    mouthElement.classList.add('talking');
                    setTimeout(() => {
                        mouthElement.classList.remove('talking');
                    }, 100 + Math.random() * 200);
                }, 150 + Math.random() * 100);
            }
        }

        function stopMouthAnimation() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            const mouthElement = animationOverlay.querySelector('.mouth-animation');
            if (mouthElement) {
                mouthElement.classList.remove('talking');
            }
        }

        function stopTalking() {
            if (currentAudio) {
                if (currentAudio instanceof Audio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                } else {
                    speechSynthesis.cancel();
                }
                currentAudio = null;
            }
            resetUI();
        }

        // Sample scripts
        const sampleScripts = [
            "Hello! I'm a good boy and I love treats!",
            "Woof woof! Let's go for a walk!",
            "Meow! I demand more tuna right now!",
            "I love you so much, human!",
            "Can we play fetch now? Please?",
            "I'm the cutest pet in the world!",
            "It's dinner time! Where's my food?",
            "I missed you all day! Welcome home!",
            "Let's go to the park and play!",
            "I'm sleepy, can we cuddle on the couch?"
        ];

        // Enhanced sample script functionality
        scriptInput.addEventListener('focus', () => {
            if (!scriptInput.value) {
                const randomScript = sampleScripts[Math.floor(Math.random() * sampleScripts.length)];
                scriptInput.placeholder = `Try: "${randomScript}"`;
            }
        });

        scriptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                generateBtn.click();
            }
        });

        // Load voices when available
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                console.log('Voices loaded:', speechSynthesis.getVoices().length);
            };
        }

        // Initialize app
        console.log('üêæ Talking Pet App Initialized');
        console.log('üé¨ Available modes: Image-to-Video, Text-to-Video');
        console.log('üîß Supported providers: Browser TTS, Kie AI Veo 3');
        
        // Set initial mode
        setGenerationMode('image-to-video');
        
        // Debug function - test Kie AI API directly from frontend
        window.debugKieAI = async function() {
            const key = apiKey.value;
            if (!key) {
                alert('Please enter your Kie AI API key first!');
                return;
            }
            
            console.log('üîç Testing Kie AI API directly from frontend...');
            
            try {
                // Test 1: Simple text-to-video request
                console.log('üì§ Test 1: Simple text-to-video request');
                const testRequest = {
                    prompt: "A cute dog sitting in a park",
                    model: "veo3_fast"
                };
                
                console.log('üì§ Sending request to:', 'https://api.kie.ai/api/v1/veo/generate');
                console.log('üì§ Request body:', testRequest);
                console.log('üì§ API key:', key.substring(0, 10) + '...');
                
                const response = await fetch('https://api.kie.ai/api/v1/veo/generate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testRequest)
                });
                
                console.log('üì• Response status:', response.status, response.statusText);
                console.log('üì• Response headers:', Object.fromEntries([...response.headers.entries()]));
                
                const responseText = await response.text();
                console.log('üì• Raw response:', responseText);
                
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                    console.log('üì• Parsed response:', responseData);
                } catch (e) {
                    console.log('üì• Response is not JSON');
                    responseData = responseText;
                }
                
                if (response.ok) {
                    alert('‚úÖ API test successful! Check console for details.\n\nResponse: ' + JSON.stringify(responseData, null, 2));
                } else {
                    alert('‚ùå API test failed!\n\nStatus: ' + response.status + '\nError: ' + responseText);
                }
                
                // Test 2: Check API credentials endpoint
                console.log('\nüì§ Test 2: Checking API credentials...');
                try {
                    const credResponse = await fetch('https://api.kie.ai/api/v1/account/credits', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${key}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('üì• Credits check status:', credResponse.status);
                    const credText = await credResponse.text();
                    console.log('üì• Credits response:', credText);
                    
                    if (credResponse.ok) {
                        console.log('‚úÖ API key is valid and working');
                    } else {
                        console.log('‚ùå API key validation failed');
                    }
                } catch (credError) {
                    console.log('‚ö†Ô∏è Could not check credits:', credError.message);
                }
                
            } catch (error) {
                console.error('üí• Debug test error:', error);
                alert('‚ùå Debug test error: ' + error.message);
            }
        };
    </script>
</body>
</html>
